#!/bin/sh

[ "$1" = "--remote" ] && {
  REMOTE_SHELL="ssh -t $2"
  shift
}

[ -n "$1" ] || {
  echo "Missing session name. Aborting." >&2
  exit 1
}
REMOTE="$1"
shift

# explicit path searching because this can be invoked by
# ssh 'tmux_attach_or_new 1', which doesn't execute .zshrc
TMUX=$HOME/bin/tmux
[ -x $TMUX ] || TMUX=$HOME/.local/bin/tmux
[ -x $TMUX ] || TMUX=/usr/local/bin/tmux
[ -x $TMUX ] || TMUX=$(which tmux)

[ -z "$REMOTE_SHELL" ] && {
  $TMUX new-session -AD -s "$REMOTE"
} || {
  $TMUX new-session -ADd -s "$REMOTE" "$REMOTE_SHELL" \; \
    set-option -s default-command "$REMOTE_SHELL" \; \
    attach
}
